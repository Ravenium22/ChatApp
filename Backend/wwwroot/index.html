<!DOCTYPE html>
<html>
<head>
    <title>Chat App - Test Panel</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f0f0f0; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { background: white; margin: 10px 0; padding: 15px; border-radius: 8px; border: 1px solid #ddd; }
        .section h3 { margin-top: 0; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 5px; }
        input, button, select { padding: 8px; margin: 5px; border: 1px solid #ccc; border-radius: 4px; }
        button { background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        .response { background: #f8f9fa; padding: 10px; margin: 10px 0; border-left: 4px solid #007bff; }
        .error { border-left-color: #dc3545; }
        .success { border-left-color: #28a745; }
        .controls { margin: 10px 0; }
        #messages { height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: #f9f9f9; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Chat App Test Panel</h1>
        
        <!-- Auth Section -->
        <div class="section">
            <h3>üîê Authentication</h3>
            <div class="controls">
                <input type="text" id="regUsername" placeholder="Username" value="testuser1">
                <input type="email" id="regEmail" placeholder="Email" value="test1@test.com">
                <input type="password" id="regPassword" placeholder="Password" value="123456">
                <button onclick="register()">Register</button>
            </div>
            <div class="controls">
                <input type="email" id="loginEmail" placeholder="Email" value="test1@test.com">
                <input type="password" id="loginPassword" placeholder="Password" value="123456">
                <button onclick="login()">Login</button>
                <button onclick="logout()">Logout</button>
                <button onclick="getProfile()">Get Profile</button>
            </div>
            <div id="authResponse" class="response"></div>
        </div>

            <!-- File Upload Section -->
            <div class="section">
                <h3>üìÅ File Upload</h3>
                <div class="controls">
                    <input type="file" id="fileInput" accept="image/*,.pdf,.doc,.docx,.txt">
                    <button onclick="uploadFile()">Upload File</button>
                </div>
                <div class="controls">
                    <input type="number" id="fileAttachmentId" placeholder="File ID">
                    <input type="text" id="fileCaption" placeholder="Caption (optional)">
                    <select id="messageType">
                        <option value="0">Text</option>
                        <option value="1">Image</option>
                        <option value="2">File</option>
                        <option value="3">Audio</option>
                        <option value="4">Video</option>
                    </select>
                    <button onclick="sendFileMessage()">Send File Message</button>
                </div>
                <div id="fileResponse" class="response"></div>
            </div>
            <!-- Friends Section -->
            <div class="section">
                <h3>üë• Friends</h3>
                <div class="controls">
                    <input type="text" id="friendUsername" placeholder="Username/Email" value="testuser2">
                    <button onclick="sendFriendRequest()">Send Friend Request</button>
                </div>
                <div class="controls">
                    <button onclick="getFriends()">Get Friends</button>
                    <button onclick="getReceivedRequests()">Get Received Requests</button>
                    <button onclick="getSentRequests()">Get Sent Requests</button>
                </div>
                <div class="controls">
                    <input type="number" id="requestId" placeholder="Request ID" min="1">
                    <select id="responseType">
                        <option value="1">Accept</option>
                        <option value="2">Reject</option>
                    </select>
                    <button onclick="respondToRequest()">Respond</button>
                </div>
                <div class="controls">
                    <input type="number" id="removeFriendId" placeholder="Friend ID" min="1">
                    <button onclick="removeFriend()">Remove Friend</button>
                </div>
                <div id="friendResponse" class="response"></div>
            </div>

            <!-- Rooms Section -->
            <div class="section">
                <h3>üè† Rooms</h3>
                <div class="controls">
                    <input type="text" id="roomName" placeholder="Room Name" value="Test Room">
                    <input type="text" id="roomDesc" placeholder="Description" value="Test Description">
                    <button onclick="createRoom()">Create Room</button>
                </div>
                <div class="controls">
                    <button onclick="getRooms()">Get All Rooms</button>
                    <button onclick="getMyRooms()">Get My Rooms</button>
                </div>
                <div class="controls">
                    <input type="number" id="roomIdJoin" placeholder="Room ID" value="1" min="1">
                    <button onclick="joinRoom()">Join Room</button>
                    <button onclick="leaveRoom()">Leave Room</button>
                </div>
                <div id="roomResponse" class="response"></div>
            </div>

            <!-- Messages Section -->
            <div class="section">
                <h3>üí¨ Messages</h3>
                <div class="controls">
                    <input type="text" id="messageContent" placeholder="Message" value="Hello World!">
                    <input type="number" id="targetRoomId" placeholder="Room ID (optional)">
                    <input type="number" id="targetUserId" placeholder="User ID (optional)">
                    <button onclick="sendMessage()">Send Message</button>
                </div>
                <div class="controls">
                    <input type="number" id="getRoomMessages" placeholder="Room ID" value="1">
                    <button onclick="getRoomMessages()">Get Room Messages</button>
                </div>
                <div class="controls">
                    <input type="number" id="getPrivateUserId" placeholder="Other User ID" value="2">
                    <button onclick="getPrivateMessages()">Get Private Messages</button>
                </div>
                <div id="messageResponse" class="response"></div>
            </div>
        </div>

        <!-- Users Section -->
        <div class="section">
            <h3>üë§ Users</h3>
            <div class="controls">
                <button onclick="getUsers()">Get All Users</button>
                <input type="number" id="getUserId" placeholder="User ID" value="1">
                <button onclick="getUser()">Get User</button>
            </div>
            <div id="userResponse" class="response"></div>
        </div>

        <!-- Real-time Messages -->
        <div class="section">
            <h3>üì° Real-time Messages</h3>
            <div id="messages"></div>
            <div class="controls">
                <input type="number" id="connectUserId" placeholder="Your User ID" value="1">
                <button onclick="connectSignalR()">Connect SignalR</button>
                <button onclick="disconnectSignalR()">Disconnect</button>
            </div>
            <div class="controls">
                <input type="text" id="realtimeMessage" placeholder="Message">
                <input type="number" id="realtimeRoomId" placeholder="Room ID (optional)">
                <input type="number" id="realtimeReceiverId" placeholder="Receiver ID (optional)">
                <input type="number" id="realtimeFileId" placeholder="File ID (optional)">
                <button onclick="sendRealtimeMessage()">Send Real-time Message</button>
            </div>
        </div>
    </div>

<script src="https://unpkg.com/@microsoft/signalr@latest/dist/browser/signalr.js"></script>
    <script>
        const API_BASE = 'http://localhost:5138/api';
        let authToken = '';

        // Helper functions
        function showResponse(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            element.className = isError ? 'response error' : 'response success';
        }

        function getHeaders() {
            const headers = { 'Content-Type': 'application/json' };
            if (authToken) headers['Authorization'] = `Bearer ${authToken}`;
            return headers;
        }

        async function apiCall(url, method = 'GET', body = null) {
            try {
                const options = { method, headers: getHeaders() };
                if (body) options.body = JSON.stringify(body);
                
                const response = await fetch(`${API_BASE}${url}`, options);
                const data = await response.json();
                
                if (!response.ok) throw data;
                return data;
            } catch (error) {
                throw error;
            }
        }

        // Auth functions
        async function register() {
            try {
                const data = await apiCall('/user/register', 'POST', {
                    username: document.getElementById('regUsername').value,
                    email: document.getElementById('regEmail').value,
                    password: document.getElementById('regPassword').value
                });
                authToken = data.token;
                showResponse('authResponse', data);
            } catch (error) {
                showResponse('authResponse', error, true);
            }
        }

        async function login() {
            try {
                const data = await apiCall('/user/login', 'POST', {
                    email: document.getElementById('loginEmail').value,
                    password: document.getElementById('loginPassword').value
                });
                authToken = data.token;
                showResponse('authResponse', data);
            } catch (error) {
                showResponse('authResponse', error, true);
            }
        }

        async function logout() {
            try {
                await apiCall('/user/logout', 'POST');
                authToken = '';
                showResponse('authResponse', { message: 'Logged out successfully' });
            } catch (error) {
                showResponse('authResponse', error, true);
            }
        }

        async function getProfile() {
            try {
                const data = await apiCall('/user/profile');
                showResponse('authResponse', data);
            } catch (error) {
                showResponse('authResponse', error, true);
            }
        }

        // Friend functions
        async function sendFriendRequest() {
            try {
                const data = await apiCall('/friend/send-request', 'POST', {
                    usernameOrEmail: document.getElementById('friendUsername').value
                });
                showResponse('friendResponse', data);
            } catch (error) {
                showResponse('friendResponse', error, true);
            }
        }

        async function getFriends() {
            try {
                const data = await apiCall('/friend/list');
                showResponse('friendResponse', data);
            } catch (error) {
                showResponse('friendResponse', error, true);
            }
        }

        async function getReceivedRequests() {
            try {
                const data = await apiCall('/friend/requests/received');
                showResponse('friendResponse', data);
            } catch (error) {
                showResponse('friendResponse', error, true);
            }
        }

        async function getSentRequests() {
            try {
                const data = await apiCall('/friend/requests/sent');
                showResponse('friendResponse', data);
            } catch (error) {
                showResponse('friendResponse', error, true);
            }
        }

        async function respondToRequest() {
            try {
                const data = await apiCall('/friend/respond', 'POST', {
                    requestId: parseInt(document.getElementById('requestId').value),
                    response: parseInt(document.getElementById('responseType').value)
                });
                showResponse('friendResponse', data);
            } catch (error) {
                showResponse('friendResponse', error, true);
            }
        }

        async function removeFriend() {
            try {
                const data = await apiCall('/friend/remove', 'DELETE', {
                    friendId: parseInt(document.getElementById('removeFriendId').value)
                });
                showResponse('friendResponse', data);
            } catch (error) {
                showResponse('friendResponse', error, true);
            }
        }

        // Room functions
        async function createRoom() {
            try {
                const data = await apiCall('/room', 'POST', {
                    name: document.getElementById('roomName').value,
                    description: document.getElementById('roomDesc').value
                });
                showResponse('roomResponse', data);
            } catch (error) {
                showResponse('roomResponse', error, true);
            }
        }

        async function getRooms() {
            try {
                const data = await apiCall('/room');
                showResponse('roomResponse', data);
            } catch (error) {
                showResponse('roomResponse', error, true);
            }
        }

        async function getMyRooms() {
            try {
                const data = await apiCall('/room/my');
                showResponse('roomResponse', data);
            } catch (error) {
                showResponse('roomResponse', error, true);
            }
        }

        async function joinRoom() {
            try {
                const roomId = document.getElementById('roomIdJoin').value;
                const data = await apiCall(`/room/${roomId}/join`, 'POST');
                showResponse('roomResponse', data);
            } catch (error) {
                showResponse('roomResponse', error, true);
            }
        }

        async function leaveRoom() {
            try {
                const roomId = document.getElementById('roomIdJoin').value;
                const data = await apiCall(`/room/${roomId}/leave`, 'POST');
                showResponse('roomResponse', data);
            } catch (error) {
                showResponse('roomResponse', error, true);
            }
        }

        // Message functions
        async function sendMessage() {
            try {
                const roomId = document.getElementById('targetRoomId').value;
                const userId = document.getElementById('targetUserId').value;
                
                const body = {
                    content: document.getElementById('messageContent').value,
                    // senderId JWT'den gelecek, g√∂ndermiyoruz
                    roomId: roomId ? parseInt(roomId) : null,
                    receiverId: userId ? parseInt(userId) : null,
                    type: 0 // MessageType.Text
                };
                
                const data = await apiCall('/message', 'POST', body);
                showResponse('messageResponse', data);
            } catch (error) {
                showResponse('messageResponse', error, true);
            }
        }

        async function getRoomMessages() {
            try {
                const roomId = document.getElementById('getRoomMessages').value;
                const data = await apiCall(`/message/room/${roomId}`);
                showResponse('messageResponse', data);
            } catch (error) {
                showResponse('messageResponse', error, true);
            }
        }

        async function getPrivateMessages() {
            try {
                const otherUserId = document.getElementById('getPrivateUserId').value;
                const data = await apiCall(`/message/private/${otherUserId}`);
                showResponse('messageResponse', data);
            } catch (error) {
                showResponse('messageResponse', error, true);
            }
        }

        // User functions
        async function getUsers() {
            try {
                const data = await apiCall('/user');
                showResponse('userResponse', data);
            } catch (error) {
                showResponse('userResponse', error, true);
            }
        }

        async function getUser() {
            try {
                const userId = document.getElementById('getUserId').value;
                const data = await apiCall(`/user/${userId}`);
                showResponse('userResponse', data);
            } catch (error) {
                showResponse('userResponse', error, true);
            }
        }

        // File upload functions
        async function uploadFile() {
            try {
                const fileInput = document.getElementById('fileInput');
                const file = fileInput.files[0];
                
                if (!file) {
                    showResponse('fileResponse', { error: 'Dosya se√ßin' }, true);
                    return;
                }

                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch(`${API_BASE}/file/upload`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: formData
                });

                const data = await response.json();
                
                if (!response.ok) throw data;
                
                // File ID'yi otomatik doldur
                document.getElementById('fileAttachmentId').value = data.id;
                showResponse('fileResponse', data);
            } catch (error) {
                showResponse('fileResponse', error, true);
            }
        }

        async function sendFileMessage() {
            try {
                const roomId = document.getElementById('targetRoomId').value;
                const userId = document.getElementById('targetUserId').value;
                const fileId = document.getElementById('fileAttachmentId').value;
                const caption = document.getElementById('fileCaption').value;
                const messageType = document.getElementById('messageType').value;
                
                if (!fileId) {
                    showResponse('fileResponse', { error: '√ñnce dosya y√ºkleyin' }, true);
                    return;
                }
                
                const body = {
                    content: caption || '',
                    roomId: roomId ? parseInt(roomId) : null,
                    receiverId: userId ? parseInt(userId) : null,
                    type: parseInt(messageType),
                    fileAttachmentId: parseInt(fileId)
                };
                
                const data = await apiCall('/message', 'POST', body);
                showResponse('fileResponse', data);
            } catch (error) {
                showResponse('fileResponse', error, true);
            }
        }
        let connection = null;

        async function connectSignalR() {
            try {
                if (connection && connection.state === signalR.HubConnectionState.Connected) {
                    addMessage('Already connected to SignalR');
                    return;
                }

                const userId = document.getElementById('connectUserId').value;
                if (!userId) {
                    addMessage('Please enter User ID', true);
                    return;
                }

                // Create connection
                connection = new signalR.HubConnectionBuilder()
                    .withUrl(`http://localhost:5138/chatHub?userId=${userId}`, {
                        accessTokenFactory: () => authToken
                    })
                    .build();

                // Set up event handlers
                connection.on("ReceiveMessage", function (message) {
                    addMessage(`Message from ${message.senderName}: ${message.content}`);
                });

                connection.on("UserJoinedRoom", function (message) {
                    addMessage(`${message.userName} joined room ${message.roomName}`, false, 'info');
                });

                connection.on("UserLeftRoom", function (message) {
                    addMessage(`${message.userName} left room ${message.roomName}`, false, 'info');
                });

                // Start connection
                await connection.start();
                addMessage('Connected to SignalR successfully!', false, 'success');
                
                // Update button states
                document.querySelector('button[onclick="connectSignalR()"]').disabled = true;
                document.querySelector('button[onclick="disconnectSignalR()"]').disabled = false;

            } catch (error) {
                console.error('SignalR connection failed:', error);
                addMessage(`Connection failed: ${error.message}`, true);
            }
        }

        async function disconnectSignalR() {
            try {
                if (connection) {
                    await connection.stop();
                    connection = null;
                    addMessage('Disconnected from SignalR', false, 'info');
                    
                    // Update button states
                    document.querySelector('button[onclick="connectSignalR()"]').disabled = false;
                    document.querySelector('button[onclick="disconnectSignalR()"]').disabled = true;
                }
            } catch (error) {
                console.error('SignalR disconnect failed:', error);
                addMessage(`Disconnect failed: ${error.message}`, true);
            }
        }

        async function sendRealtimeMessage() {
            try {
                if (!connection || connection.state !== signalR.HubConnectionState.Connected) {
                    addMessage('Not connected to SignalR', true);
                    return;
                }

                const content = document.getElementById('realtimeMessage').value;
                const roomId = document.getElementById('realtimeRoomId').value;
                const receiverId = document.getElementById('realtimeReceiverId').value;
                const fileId = document.getElementById('realtimeFileId').value;

                if (!content.trim()) {
                    addMessage('Please enter a message', true);
                    return;
                }

                const messageData = {
                    content: content.trim(),
                    roomId: roomId ? parseInt(roomId) : null,
                    receiverId: receiverId ? parseInt(receiverId) : null,
                    fileAttachmentId: fileId ? parseInt(fileId) : null,
                    type: 0 // Text message
                };

                await connection.invoke("SendMessage", messageData);
                
                // Clear input
                document.getElementById('realtimeMessage').value = '';
                addMessage(`Message sent: ${content}`, false, 'success');

            } catch (error) {
                console.error('Send message failed:', error);
                addMessage(`Send failed: ${error.message}`, true);
            }
        }

        function addMessage(message, isError = false, type = null) {
            const messagesDiv = document.getElementById('messages');
            const messageElement = document.createElement('div');
            messageElement.style.padding = '5px';
            messageElement.style.margin = '2px 0';
            messageElement.style.borderRadius = '4px';
            
            if (isError) {
                messageElement.style.backgroundColor = '#ffebee';
                messageElement.style.color = '#c62828';
                messageElement.style.border = '1px solid #ef5350';
            } else if (type === 'success') {
                messageElement.style.backgroundColor = '#e8f5e8';
                messageElement.style.color = '#2e7d32';
                messageElement.style.border = '1px solid #4caf50';
            } else if (type === 'info') {
                messageElement.style.backgroundColor = '#e3f2fd';
                messageElement.style.color = '#1565c0';
                messageElement.style.border = '1px solid #2196f3';
            } else {
                messageElement.style.backgroundColor = '#f5f5f5';
                messageElement.style.border = '1px solid #ddd';
            }
            
            messageElement.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
}
    </script>
</body>
</html>